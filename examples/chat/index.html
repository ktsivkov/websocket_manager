<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
<div class="container p-5">
    <div class="row">
        <div class="col-md-8">
            <div class="input-group mb-3">
                <span class="input-group-text" id="username-label">@</span>
                <input type="text" id="username" class="form-control" placeholder="Username" aria-label="Username"
                       aria-describedby="username-label">
            </div>
        </div>
        <div class="col-md-4">
            <div class="d-grid">
                <button id="btn-connect" type="button" class="btn btn-success" onclick="connect()">Connect</button>
                <button id="btn-disconnect" type="button" class="btn btn-danger d-none" onclick="disconnect()">Disconnect</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12" id="messages"></div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <select id="target" disabled="disabled" class="form-select form-select" aria-label="Large select example">
                <option selected value="">Everyone</option>
            </select>
        </div>
        <div class="col-md-8">
            <div class="input-group mb-3">
                <input type="text" disabled="disabled" id="message" class="form-control" placeholder="Type your message"
                       aria-label="Type your message" aria-describedby="message-label">
                <button id="btn-send" type="button" class="btn btn-primary" disabled="disabled" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
<script>
    function connectedMessage(username) {
        const element = document.createElement("div");
        element.classList.add("alert","alert-success", "m-3");
        element.setAttribute("role","alert");
        element.textContent = `${username} joined the chat.`;
        return element;
    }
    function disconnectedMessage(username) {
        const element = document.createElement("div");
        element.classList.add("alert","alert-warning", "m-3");
        element.setAttribute("role","alert");
        element.textContent = `${username} left the chat.`;
        return element;
    }
    function chatMessage(message) {
        const header = document.createElement('h5');
        header.classList.add('card-header');
        header.textContent = `From: ${message.from}`;

        const text = document.createElement('p');
        text.classList.add('card-text');
        text.textContent = message.message;

        const body = document.createElement('div');
        body.classList.add('card-body');
        body.appendChild(text);

        const card = document.createElement('div');
        card.classList.add('card', 'm-3');
        card.appendChild(header);
        card.appendChild(body);
        return card;
    }

    function renderInChat(element) {
        document.getElementById("messages").appendChild(element);
        window.scrollTo(0, document.body.scrollHeight);
    }

    function connect() {
        const username = document.getElementById("username").value;
        if (!username || username.trim() === "") {
            alert("Please enter a username.");
            return
        }
        window.ws = new WebSocket(`ws://localhost:8080/ws?username=${username}`);
        window.ws.onopen = function () {
            document.getElementById("btn-connect").classList.add("d-none");
            document.getElementById("btn-disconnect").classList.remove("d-none");
            document.getElementById("btn-send").removeAttribute("disabled");
            document.getElementById("username").setAttribute("disabled", "disabled");
            document.getElementById("message").removeAttribute("disabled");
            document.getElementById("target").removeAttribute("disabled");
            resetTargetInput();
        }
        window.ws.onmessage = function (event) {
            console.log(event);
            const message = JSON.parse(event.data);
            switch (message.type) {
                case "user_connected":
                    renderTargetOptions([targetOption(message.data)]);
                    renderInChat(connectedMessage(message.data));
                    return
                case "user_disconnected":
                    removeTargetOptions(message.data)
                    renderInChat(disconnectedMessage(message.data));
                    return
                case "client_list":
                    renderTargetOptions(message.data.map(targetOption));
                    return;
                case "chat":
                    renderInChat(chatMessage(message.data));
                    return
            }
        }
        window.ws.onerror = function (event) {
            console.log("Error:", event);
            alert(`Error: ${event.data}`)
        }
        window.ws.onclose = function (event) {
            console.log("Close:", event);
            document.getElementById("btn-connect").classList.remove("d-none");
            document.getElementById("btn-disconnect").classList.add("d-none");
            document.getElementById("btn-send").setAttribute("disabled", "disabled");
            document.getElementById("username").removeAttribute("disabled");
            document.getElementById("message").setAttribute("disabled", "disabled");
            document.getElementById("target").setAttribute("disabled", "disabled");
            resetTargetInput();
            switch (event.code) {
                case 1008:
                    const reason = JSON.parse(event.reason);
                    alert(`Error: ${reason.message}`);
                    return
            }
        }
    }

    function renderTargetOptions(targetOptions) {
        targetOptions.forEach(option => {
            document.getElementById("target").appendChild(option);
        });
    }

    function removeTargetOptions(username) {
        const options = document.querySelectorAll("#target option");
        options.forEach(option => {
            if (option.getAttribute("value") === username) {
                option.remove();
            }
        });
    }

    function targetOption(username) {
        const option = document.createElement("option");
        option.innerText = username;
        option.setAttribute("value", username);
        return option;
    }

    function resetTargetInput() {
        document.getElementById("target").innerHTML = "";
        const option = document.createElement("option");
        option.innerText = "Everyone";
        option.value = "";
        option.setAttribute("selected", "selected");
        document.getElementById("target").appendChild(option);
    }

    function sendMessage() {
        if (!window.ws) {
            return
        }

        window.ws.send(JSON.stringify({
            "to": document.getElementById("target").value,
            "message": document.getElementById("message").value
        }))
        // window.ws.send("ASDasddasdasasd")
    }

    function disconnect() {
        window.ws.close();
    }
</script>
</body>
</html>